<p-drawer
    [visible]="isShow"
    (visibleChange)="onVisibleChange($event)"
    position="right"
    styleClass="max-w-[950px] !w-[100%] "
    [header]="isEditMode ? 'Cập nhật thông tin thành viên' : 'Thêm thông tin thành viên'"
>
    <form
        [formGroup]="form"
        (ngSubmit)="submit()"
        class="py-3 space-y-4 userForm"
    >
        <div class="flex__middle flex-col md:flex-row gap-4">
            <div class="w-1/3 h-auto aspect-square">
                <div class="w-full h-full cursor-pointer">
                    <img
                        (click)="fileInput?.click()"
                        [src]="avatarUrl"
                        class="overflow-hidden w-full aspect-square rounded-full object-cover"
                        alt=""
                    />
                </div>
                <input
                    #fileInput
                    type="file"
                    accept="image/*"
                    class="hidden"
                    (change)="onAvatarFileChange($any($event.target).files?.[0])"
                />
            </div>
            <div class="flex__middle flex-col w-full gap-4">
                <div class="flex__middle w-full gap-4">
                    <p-floatlabel variant="in" class="!w-full">
                        <p-iconfield class="!w-full">
                            <p-inputicon class="pi pi-envelope" />
                            <input
                                #emailInput
                                pInputText
                                id="email"
                                formControlName="email"
                                [attr.readonly]="isEditMode ? true : null"
                                class="w-full"
                                autocomplete="off"
                                [invalid]="isInvalid('email')"
                            />
                            <label for="email">Email (*)</label>
                        </p-iconfield>
                    </p-floatlabel>
                    <p-floatlabel variant="in" class="!w-full">
                        <p-iconfield class="!w-full">
                            <p-inputicon class="pi pi-user" />
                            <input
                                pInputText
                                id="name"
                                formControlName="name"
                                class="w-full"
                                autocomplete="off"
                                [invalid]="isInvalid('name')"
                            />
                            <label for="name">Họ và tên (*)</label>
                        </p-iconfield>
                    </p-floatlabel>
                </div>
                @if(!isEditMode){
                <div class="flex__middle w-full gap-4">
                    <p-floatlabel variant="in" class="!w-full">
                        <p-iconfield class="!w-full">
                            <p-inputicon class="pi pi-lock" />
                            <p-password
                                pSize="small"
                                class="!w-full"
                                formControlName="password"
                                inputId="password"
                                autocomplete="new-password"
                                [toggleMask]="true"
                                promptLabel="Nhập mật khẩu của bạn"
                                weakLabel="Mật khẩu quá đơn giản"
                                mediumLabel="Mật khẩu có độ phức tạp trung bình"
                                strongLabel="Mật khẩu mạnh"
                            >
                                <ng-template #header>
                                    <div class="font-semibold text-xm !mb-2">
                                        Chọn một mật khẩu
                                    </div>
                                </ng-template>
                                <ng-template #footer>
                                    <p-divider />
                                    <ul
                                        class="pl-2 ml-2 !mt-2 my-0 leading-normal"
                                    >
                                        <li>
                                            Mật khẩu phải chứa ít nhất một chữ
                                            cái viết hoa
                                        </li>
                                        <li>
                                            Mật khẩu phải chứa ít nhất một chữ
                                            cái viết thường
                                        </li>
                                        <li>
                                            Mật khẩu phải chứa ít nhất một số
                                        </li>
                                        <li>
                                            Mật khẩu phải chứa ít nhất một ký tự
                                            đặc biệt
                                        </li>
                                        <li>
                                            Mật khẩu phải có ít nhất 8 ký tự
                                        </li>
                                        <li>
                                            Mật khẩu không được vượt quá 16 ký
                                            tự
                                        </li>
                                    </ul>
                                </ng-template>
                            </p-password>
                        </p-iconfield>
                        <label for="password">Mật khẩu (*)</label>
                    </p-floatlabel>

                    <p-floatlabel variant="in" style="width: 100%">
                        <p-iconfield class="w-full">
                            <p-inputicon class="pi pi-lock" />
                            <p-password
                                pSize="small"
                                class="!w-full"
                                formControlName="confirmPassword"
                                inputId="confirmPassword"
                                [feedback]="true"
                                autocomplete="new-password"
                                [toggleMask]="true"
                                promptLabel="Nhập mật khẩu của bạn"
                                weakLabel="Mật khẩu quá đơn giản"
                                mediumLabel="Mật khẩu có độ phức tạp trung bình"
                                strongLabel="Mật khẩu mạnh"
                                [ngClass]="{
                                  'ng-invalid ng-dirty':
                                    form.errors?.['passwordMismatch'] ||
                                    (form.get('confirmPassword')?.touched &&
                                      form.get('confirmPassword')?.errors),
                                }"
                            >
                                <ng-template #header>
                                    <div class="font-semibold text-xm !mb-2">
                                        Nhập lại mật khẩu
                                    </div>
                                </ng-template>
                                <ng-template #footer>
                                    <p-divider />
                                    @if (form.get("confirmPassword")?.touched) {
                                    <ul
                                        class="!mt-2 my-0 leading-normal text-red-500"
                                    >
                                        @if (
                                        form.get("confirmPassword")?.errors?.["required"]
                                        ) {
                                        <li>Mật khẩu là bắt buộc</li>
                                        } @if
                                        (form.errors?.["passwordMismatch"]) {
                                        <li>Mật khẩu không khớp</li>
                                        }
                                    </ul>
                                    }
                                </ng-template>
                            </p-password>
                        </p-iconfield>
                        <label for="confirmPassword"
                            >Nhập lại mật khẩu (*)</label
                        >
                    </p-floatlabel>
                </div>
                }

                <div class="flex__middle w-full gap-4">
                    <p-floatlabel variant="in" class="!w-full">
                        <p-iconfield class="!w-full">
                            <p-inputicon class="pi pi-phone" />
                            <input
                                pInputText
                                id="phoneNumber"
                                formControlName="phoneNumber"
                                class="w-full"
                                autocomplete="off"
                                [invalid]="isInvalid('phoneNumber')"
                            />
                            <label for="phoneNumber">Số điện thoại</label>
                        </p-iconfield>
                    </p-floatlabel>

                    <p-floatlabel class="w-full" variant="in">
                        <p-multiselect
                            inputId="roleKeys"
                            formControlName="roleKeys"
                            [invalid]="isInvalid('roleKeys')"
                            [options]="roles()"
                            optionLabel="name"
                            optionValue="key"
                            [filter]="true"
                            class="w-full"
                            variant="filled"
                        >
                        </p-multiselect>
                        <label for="roleKeys">Nhóm thành viên (*)</label>
                    </p-floatlabel>
                </div>
                <p-floatlabel variant="in" class="!w-full">
                    <p-iconfield class="!w-full">
                        <p-inputicon class="pi pi-map" />
                        <input
                            pInputText
                            id="addresses"
                            formControlName="addresses"
                            class="w-full"
                            autocomplete="off"
                            [invalid]="isInvalid('addresses')"
                        />
                        <label for="addresses">Địa chỉ</label>
                    </p-iconfield>
                </p-floatlabel>
            </div>
        </div>
        <div class="relative">
            <p-picklist
                [source]="sourcePermissions"
                [target]="targetPermissions"
                [dragdrop]="false"
                [responsive]="true"
                filterBy="name"
                sourceFilterPlaceholder="Tìm kiếm"
                targetFilterPlaceholder="Tìm kiếm"
                breakpoint="750px"
                scrollHeight="15rem"
                dataKey="id"
                (onMoveToTarget)="onMoveToTarget($event)"
                (onMoveToSource)="onMoveToSource($event)"
            >
                <ng-template let-option let-selected="selected">
                    <div class="p-1">
                        <span class="font-medium text-sm"
                            >{{ option.name }}</span
                        >
                    </div>
                </ng-template>
            </p-picklist>

            @if(loading){
            <div
                class="absolute inset-0 flex items-center justify-center w-full h-full bg-gray-100/50"
            >
                <i class="pi pi-spinner-dotted !text-3xl animate-spin"></i>
            </div>
            }
        </div>
    </form>
    <ng-template #footer>
        <button
            (click)="submit()"
            class="rounded-md w-full py-2 border border-primary text-primary hover:bg-primary hover:text-white"
        >
            <i
                class="pi mr-3"
                [ngClass]="isEditMode? 'pi-pen-to-square':'pi-plus-circle' "
            ></i>
            {{ isEditMode ? 'Cập nhật ngay' : 'Thêm mới' }}
        </button>
    </ng-template>
</p-drawer>
